from base_etl import BaseETL
import pandas as pd

class reoperationrecordstep01(BaseETL):
    def run(
        self,
    ):
        sql = '''
            SELECT
                distinct
                원무접수ID,
                환자번호,
                의무기록작성일,
                진료서식ID
            FROM 
                operation_record
        '''
        df = self.df_from_sql(db_name="gc_raw", sql=sql)

        one = [100471611, 100471612, 100471615, 100471618, 100471626, 
                100471627, 100471629, 100471630,100471632, 100471643, 
                100471644, 100471662, 100471637, 100471640, 100471709,
                100471712, 100471594, 100471597, 100471758, 100471757,
                100471755, 100471754, 100471443, 100471444, 100471445,
                100471446, 100471454, 100471455, 100471456, 100471457,
                100710195, 100710197, 100471698, 100471699]
        two = [332474062775371156922005003276586315671, 
               102796988583323715749240121013225909884, 
               185830551150414080091269923411845302168, 
               112901479595981703495712548023589627934,
               27412416570614036307552665748439570426, 
               240516312749309334717993984418284479785,
               6773630525883575685182309869433808051, 
               51783288511349514297223764916540101995,
               313654651641644809870281935680945347196, 
               46305585094617802692461308304008806091,  
               54362991114128129122868661735348392881,
               117626825450869221113379904877574207656,
               211132544143300281957730745846752456104,
               277726857703520087907871802455987333267,
               185252726691065625067257742776480424426,
               188538012042502481363235318515264159659,
               59563968572860805248822468147357804278, 
               20872259308977042918437275034640051818,
               336031965029532489481092144848319722828,
               76578174260349347592487582186102992750,
               7490049260610654599492159067683468099,
               60224821248114936719775582859277029991,
               59082602573457031949518292961117860950,
               308532366144679811687532755570951668109,
               210670099508248483797720727461360692279,
               69990479034887735738362169618908754902,
               454057071970133972526320676058793014,
               196561237638732880813586368827253288995,
               290160481844182192859776994219220626042,
               131841167767876147453217318280454791397,
               327856644192692300859737489956904054878,
               33800173018676698038869789567582976327,
               103139997452417354342167276657422624058,
               336625455077432447804302223962177717741
               ]
        
        

        for x, y in zip(one, two):
            f = open("OP/re_operation_record_sql1.sql",'rt',encoding='UTF8')
            sql= ''
            while True:
                line = f.readline()
                if not line: break
                a = str(line)
                sql  = sql + a
            sql = sql.format(x,y) 
            f.close()
            data = self.df_from_sql(db_name="gc_raw", sql=sql)
            df = pd.merge(df, data, how='left',on=['원무접수ID','의무기록작성일','진료서식ID','환자번호'])
        print(df)
        self.insert(df, db_name="gc_protocol", tb_name="re_operation_record_step_01") 


if __name__ == "__main__":
    obj = reoperationrecordstep01()
    obj.run()

